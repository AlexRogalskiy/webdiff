{%- extends "base.html" -%}

{% block title %} Diff {% endblock %}

{% block head %}
{% endblock %}

{% block body %}

<div id="application"></div>

<script src="/static/js/file_diff.js"></script>
<!--<script src="/static/js/components.js"></script>-->

<script>var pairs = {{pairs|tojson}};</script>

<script type="text/jsx">
/** @jsx React.DOM */

var Root = React.createClass({
  getInitialState: function() {
    return {
      selectedFileIndex: 0,
      imageDiffMode: 'side-by-side'
    };
  },
  fileChangeHandler: function(idx) {
    this.setState({selectedFileIndex: idx});
  },
  changeImageDiffModeHandler: function(mode) {
    this.setState({imageDiffMode: mode});
  },
  render: function() {

    var filePair = this.props.filePairs[this.state.selectedFileIndex];

    // TODO: move ImageDiffModeSelector into <DiffView>?
    return <div>
       <FileSelector selectedFileIndex={this.state.selectedFileIndex}
                     filePairs={this.props.filePairs}
                     fileChangeHandler={this.fileChangeHandler} />
       <ImageDiffModeSelector filePair={filePair}
                              mode={this.state.imageDiffMode}
                              changeHandler={this.changeImageDiffModeHandler}/>
       <DiffView filePair={filePair} imageDiffMode={this.state.imageDiffMode} />
    </div>
  },
  componentDidMount: function() {
    $(document).on('keydown', function(e) {
      if (!isLegitKeypress(e)) return;
      var idx = this.state.selectedFileIndex;
      if (e.keyCode == 75) {  // j
        if (idx > 0) {
          this.setState({selectedFileIndex: idx - 1});
        }
      } else if (e.keyCode == 74) {  // k
        if (idx < this.props.filePairs.length - 1) {
          this.setState({selectedFileIndex: idx + 1});
        }
      } else if (e.keyCode == 83) {  // s
        this.setState({imageDiffMode: 'side-by-side'});
      } else if (e.keyCode == 66) {  // b
        this.setState({imageDiffMode: 'blink'});
      }
    }.bind(this));
  }
});

var FileSelector = React.createClass({
  getInitialState: function() {
    return {mode: 'list'};
  },
  render: function() {
    var selector;
    if (this.state.mode == 'list') {
      selector = <FileList filePairs={this.props.filePairs}
                           selectedIndex={this.props.selectedFileIndex}
                           fileChangeHandler={this.props.fileChangeHandler} />;
    } else {
      selector = <FileDropdown filePairs={this.props.filePairs}
                               selectedIndex={this.props.selectedFileIndex}
                               fileChangeHandler={this.props.fileChangeHandler} />;
    }

    return <div className="file-selector">
      {selector}
      <FileModeSelector mode={this.state.mode}
                        changeHandler={this.changeSelectionModeHandler} />
    </div>
  },
  changeSelectionModeHandler: function(mode) {
    this.setState({mode: mode});
  }
});

var FileModeSelector = React.createClass({
  render: function() {
    return <div>
      <button data-mode="list"
              disabled={this.props.mode == 'list'}
              onClick={this.changeHandler}>List</button>
      <button data-mode="dropdown"
              disabled={this.props.mode == 'dropdown'}
              onClick={this.changeHandler}>Dropdown</button>
    </div>
  },
  changeHandler: function(e) {
    this.props.changeHandler($(e.target).attr('data-mode'));
  }
});

var FileList = React.createClass({
  render: function() {
    var props = this.props;
    var lis = this.props.filePairs.map(function(file_pair, idx) {
          if (idx != props.selectedIndex) {
            return <li key={'fl-' + idx}><a data-idx={idx} onClick={this.clickHandler} href='#'>{file_pair.path}</a></li>
          } else {
            return <li key={'fl-' + idx}><b>{file_pair.path}</b></li>
          }
        }.bind(this));
    return <ul>{lis}</ul>
  },
  clickHandler: function(e) {
    this.props.fileChangeHandler(parseInt($(e.target).attr('data-idx'), 10));
  }
});

var FileDropdown = React.createClass({
  render: function() {
    var props = this.props;

    var linkOrNone = function(idx) {
      if (idx < 0 || idx >= props.filePairs.length) {
        return <i>none</i>;
      } else {
        return <a href='#' data-idx={idx} onClick={this.handleLinkClick}>{props.filePairs[idx].path}</a>;
      }
    }.bind(this);

    var prevLink = linkOrNone(props.selectedIndex - 1);
    var nextLink = linkOrNone(props.selectedIndex + 1);

    var options = this.props.filePairs.map(function(file_pair, idx) {
      var option = <option key={'fd-' + idx} value={idx}>{file_pair.path} ({file_pair.type})</option>;
      if (idx == props.selectedIndex) {
        option.props.selected = true;
      }
      return option;
    });
    return <div>
      Prev (k): {prevLink}<br/>
      <select onChange={this.handleDropdownChange}>{options}</select><br/>
      Next (j): {nextLink}
    </div>
  },
  handleDropdownChange: function(e) {
    this.props.fileChangeHandler(parseInt($(e.target).val(), 10));
  },
  handleLinkClick: function(e) {
    this.props.fileChangeHandler(parseInt($(e.target).attr('data-idx'), 10));
  }
});

var ImageDiffModeSelector = React.createClass({
  render: function() {
    if (!this.props.filePair.is_image_diff) {
      return <span/>;  // have to return something.
    }

    // Returns the text, optionally wrapped in a link and/or <b> tag.
    var linkOrB = function(isLink, isB, val, text) {
      var inner = isB ? <b>{text}</b> : text;
      if (isLink) {
        return <a href='#' onClick={this.handleClick} value={val}>{inner}</a>
      } else {
        return inner;
      }
    }.bind(this);

    var isBlink = this.props.mode == 'blink';
    return <div>
      {linkOrB(isBlink, !isBlink, 'side-by-side', 'Side by Side (s)')} |
      {linkOrB(true, isBlink, 'blink', 'Blink (b)')}
    </div>
  },
  handleClick: function(e) {
    this.props.changeHandler($(e.target).attr('value'));
  }
});

var DiffView = React.createClass({
  render: function() {
    if (this.props.filePair.is_image_diff) {
      return <ImageDiff mode={this.props.imageDiffMode}
                        filePair={this.props.filePair} />
    } else {
      return <CodeDiff filePair={this.props.filePair} />
    }
  }
});

var CodeDiff = React.createClass({
  render: function() {
    return <div key={'cd-' + this.props.filePair.idx}>Loading&hellip;</div>
  },
  renderDiff: function() {
    // Do XHRs for the contents of both sides and fill in the diff.
    var pair = this.props.filePair;
    var beforeDeferred = getOrNull('a', pair.a);
    var afterDeferred = getOrNull('b', pair.b);

    var self = this;
    $.when(beforeDeferred, afterDeferred).done(function(before, after) {
      if (!self.isMounted()) return;
      $(self.getDOMNode()).empty().append(
          renderDiff(pair.a, pair.b, before[0], after[0]));
    }).fail(function(e) {
      alert("Unable to get diff!");
    });
  },
  componentDidMount: function() {
    this.renderDiff();  // Called on initial display of this component.
  },
  componentDidUpdate: function() {
    this.componentDidMount();  // Called on updates.
  }
});

var ImageDiff = React.createClass({
  render: function() {
    return this.props.mode == 'side-by-side' ?
      <ImageSideBySide filePair={this.props.filePair} /> :
      <ImageBlinker filePair={this.props.filePair} />;
  }
});

var ImageSideBySide = React.createClass({
  render: function() {
    var pair = this.props.filePair;
    var aImage = pair.a ? <img src={'/a/image/' + pair.a} /> : 'None';
    var bImage = pair.b ? <img src={'/a/image/' + pair.b} /> : 'None';
    return <table id="imagediff">
      <tr className="image-diff-header">
        <td className="diff-left">{pair.a || 'None'}</td>
        <td className="diff-right">{pair.b || 'None'}</td>
      </tr>
      <tr className="image-diff-content">
        <td className="diff-left">{aImage}</td>
        <td className="diff-right">{bImage}</td>
      </tr>
    </table>
  }
});

var ImageBlinker = React.createClass({
  getInitialState: function() {
    return {idx: 0};
  },
  render: function() {
    var pair = this.props.filePair;
    var side = ['a', 'b'][this.state.idx];
    var path = [pair.a, pair.b][this.state.idx];
    var img = path ? <img src={'/' + side + '/image/' + path} /> : 'None'
    return <div>
      <h3>{path} ({side == 'a' ? 'left' : 'right'})</h3>
      {img}
    </div>
  },
  componentDidMount: function() {
    var toggle = function() {
      if (this.isMounted()) {
        this.setState({idx: 1 - this.state.idx});
      }
    }.bind(this);

    $(document).on('keydown.blink', function(e) {
      if (!isLegitKeypress(e)) return;
      if (e.keyCode == 66) {  // 'b'
        toggle();
      }
    }).on('click.blink', 'a[value="blink"]', toggle);
  },
  componentDidUnmount: function(e) {
    $(document).off('keydown.blink').off('click.blink');
  }
});

var applicationRoot = Root({filePairs: pairs});
React.renderComponent(applicationRoot, $('#application').get(0));
</script>

<!--
<div id="controls">
  <p>Prev (k): {% if idx > 0 %}
    <a class="prev" href="/{{idx - 1}}">{{pairs[idx-1].path}}</a>
    {% else %}
    <i>none</i>
    {% endif %}
    <br>
    Diff: <select id=pair-chooser>
      {% for pair in pairs %}
      <option value={{pair.idx}} {%if pair.idx == idx%}selected{%endif%}>{{pair.path}} ({{pair.type}})</option>
      {% endfor %}
    </select>
    <br>Next (j):
    {% if idx < num_pairs - 1 %}
    <a class="next" href="/{{idx + 1}}">{{pairs[idx+1].path}}</a>
    {% else %}
    <i>none</i>
    {% endif %}
  </p>
  <p id="imagediff-controls" style="display:none">
    <br>
    Image diff mode:
    <a id="image-side-by-side" onclick="handleSideBySide()" style="font-weight:bold">side-by-side</a>
    -
    <a href="#" id="image-blink" onclick="handleBlink()">blink (b)</a>
  </p>
</div>

<div id="thediff">
  Loading diff&hellip;
</div>

<table id="imagediff" style="display:none">
  <tr class="image-diff-header">
    <td class="diff-left"><div class="diff-header"></div></td>
    <td class="diff-right"><div class="diff-header"></div></td>
  </tr>
  <tr class="image-diff-content">
    <td class="diff-left"><img /></td>
    <td class="diff-right"><img /></td>
  </tr>
</table>

<script type="text/javascript">
// Filled in via XHR below.
// Inlining is appealing, but can result in too much data.
var beforeContents;
var afterContents;

var a_file = {{this_pair.a|tojson}};
var b_file = {{this_pair.b|tojson}};
var is_image_diff = {{is_image_diff|tojson}};
</script>
-->

<!--
<script type="text/javascript">

$(function() {
  if (!is_image_diff) {
    var beforeDeferred = getOrNull('a', a_file);
    var afterDeferred = getOrNull('b', b_file);

    $.when(beforeDeferred, afterDeferred).done(function(before, after) {
      beforeContents = before[0];
      afterContents = after[0];
      updateWithBeforeAfterContents();
    }).fail(function(e) {
      alert("Unable to get diff!");
    });
  } else {
    $('#imagediff .diff-left .diff-header').text(a_file || 'None');
    $('#imagediff .diff-right .diff-header').text(b_file || 'None');

    if (a_file) {
      $('#imagediff .diff-left img').attr('src', '/a/image/' + a_file);
    } else {
      $('#imagediff .diff-left').text('None');
    }
    if (b_file) {
      $('#imagediff .diff-right img').attr('src', '/b/image/' + b_file);
    } else {
      $('#imagediff .diff-right').text('None');
    }

    $('#thediff').hide();
    $('#imagediff').show();
    $('#imagediff-controls').show();
  }
  attachHandlers();
});

function updateWithBeforeAfterContents() {
  displayDiffs(a_file, b_file, beforeContents, afterContents);
}
</script>
-->
{% endblock %}
