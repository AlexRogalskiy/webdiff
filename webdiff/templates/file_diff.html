{%- extends "base.html" -%}

{% block title %} Diff {% endblock %}

{% block head %}
{% endblock %}

{% block body %}

<div id="application"></div>

<script src="/static/js/file_diff.js"></script>
<!--<script src="/static/js/components.js"></script>-->

<script>var pairs = {{pairs|tojson}};</script>

<script type="text/jsx">
/** @jsx React.DOM */

var Root = React.createClass({
  getInitialState: function() {
    return {selectedFileIndex: 0};
  },
  fileChangeHandler: function(e) {
    this.setState({selectedFileIndex: $(e.target).attr('data-idx')});
  },
  render: function() {
    return <div>
             <FileList filePairs={this.props.filePairs}
                            selectedIndex={this.state.selectedFileIndex}
                            fileChangeHandler={this.fileChangeHandler} />
             <DiffView filePair={this.props.filePairs[this.state.selectedFileIndex]} />
          </div>
  }
});

var FileList = React.createClass({
  render: function() {
    var props = this.props;
    var lis = this.props.filePairs.map(function(file_pair, idx) {
          if (idx != props.selectedIndex) {
            return <li key={'fp-' + idx}><a data-idx={idx} onClick={props.fileChangeHandler} href='#'>{file_pair.path}</a></li>
          } else {
            return <li key={'fp-' + idx}><b>{file_pair.path}</b></li>
          }
        });
    return <ul>{lis}</ul>
  }
});

var DiffView = React.createClass({
  render: function() {
    if (this.props.filePair.is_image_diff) {
      return <ImageDiff filePair={this.props.filePair} />
    } else {
      return <CodeDiff filePair={this.props.filePair} />
    }
  }
});

var CodeDiff = React.createClass({
  contents: {},
  render: function() {
    return <div key={'cd-' + this.props.filePair.idx}>Loading&hellip;</div>
  },
  componentDidMount: function() {
    // Do XHRs for the contents of both sides and update props when we get them.
    var pair = this.props.filePair;
    var beforeDeferred = getOrNull('a', pair.a);
    var afterDeferred = getOrNull('b', pair.b);

    var self = this;
    $.when(beforeDeferred, afterDeferred).done(function(before, after) {
      if (!self.isMounted()) return;
      $(self.getDOMNode()).empty().append(
          renderDiff(pair.a, pair.b, before[0], after[0]));
    }).fail(function(e) {
      alert("Unable to get diff!");
    });
  },
  componentDidUpdate: function() {
    this.componentDidMount();
  }
});

var ImageDiff = React.createClass({
  render: function() {
  }
});

React.renderComponent(Root({
  filePairs: pairs,
  fileChangeHandler: function(e) {
    console.log('Clicked', e);
  }
}), $('#application').get(0));
</script>

<!--
<div id="controls">
  <p>Prev (k): {% if idx > 0 %}
    <a class="prev" href="/{{idx - 1}}">{{pairs[idx-1].path}}</a>
    {% else %}
    <i>none</i>
    {% endif %}
    <br>
    Diff: <select id=pair-chooser>
      {% for pair in pairs %}
      <option value={{pair.idx}} {%if pair.idx == idx%}selected{%endif%}>{{pair.path}} ({{pair.type}})</option>
      {% endfor %}
    </select>
    <br>Next (j):
    {% if idx < num_pairs - 1 %}
    <a class="next" href="/{{idx + 1}}">{{pairs[idx+1].path}}</a>
    {% else %}
    <i>none</i>
    {% endif %}
  </p>
  <p id="imagediff-controls" style="display:none">
    <br>
    Image diff mode:
    <a id="image-side-by-side" onclick="handleSideBySide()" style="font-weight:bold">side-by-side</a>
    -
    <a href="#" id="image-blink" onclick="handleBlink()">blink (b)</a>
  </p>
</div>

<div id="thediff">
  Loading diff&hellip;
</div>

<table id="imagediff" style="display:none">
  <tr class="image-diff-header">
    <td class="diff-left"><div class="diff-header"></div></td>
    <td class="diff-right"><div class="diff-header"></div></td>
  </tr>
  <tr class="image-diff-content">
    <td class="diff-left"><img /></td>
    <td class="diff-right"><img /></td>
  </tr>
</table>

<script type="text/javascript">
// Filled in via XHR below.
// Inlining is appealing, but can result in too much data.
var beforeContents;
var afterContents;

var a_file = {{this_pair.a|tojson}};
var b_file = {{this_pair.b|tojson}};
var is_image_diff = {{is_image_diff|tojson}};
</script>
-->

<!--
<script type="text/javascript">

$(function() {
  if (!is_image_diff) {
    var beforeDeferred = getOrNull('a', a_file);
    var afterDeferred = getOrNull('b', b_file);

    $.when(beforeDeferred, afterDeferred).done(function(before, after) {
      beforeContents = before[0];
      afterContents = after[0];
      updateWithBeforeAfterContents();
    }).fail(function(e) {
      alert("Unable to get diff!");
    });
  } else {
    $('#imagediff .diff-left .diff-header').text(a_file || 'None');
    $('#imagediff .diff-right .diff-header').text(b_file || 'None');

    if (a_file) {
      $('#imagediff .diff-left img').attr('src', '/a/image/' + a_file);
    } else {
      $('#imagediff .diff-left').text('None');
    }
    if (b_file) {
      $('#imagediff .diff-right img').attr('src', '/b/image/' + b_file);
    } else {
      $('#imagediff .diff-right').text('None');
    }

    $('#thediff').hide();
    $('#imagediff').show();
    $('#imagediff-controls').show();
  }
  attachHandlers();
});

function updateWithBeforeAfterContents() {
  displayDiffs(a_file, b_file, beforeContents, afterContents);
}
</script>
-->
{% endblock %}
